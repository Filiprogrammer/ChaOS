ifeq ($(TEST), 1)
SOURCESTEST = $(wildcard src-test/*.c)
OBJECTSTEST = $(addprefix obj-test/,$(addsuffix .o,$(notdir $(basename $(SOURCESTEST)))))
endif

SOURCES = src/kernel.asm $(filter-out src/kernel.asm ,$(wildcard src/*.asm src/*.c))
OBJECTS = $(addprefix obj/,$(addsuffix .o,$(notdir $(basename $(SOURCES)))))

ASFLAGSOBJ= -O32 -f elf
ASFLAGSOBJDEBUG= -O32 -f elf -ggdb
NASM = nasmw
MAKE = mingw32-make

CFLAGS= -std=c99 -march=i386 -mtune=i386 -Werror -Wall -O -ffreestanding -fleading-underscore -nostdlib -nostdinc -fno-builtin -fno-stack-protector -Isrc/include
CFLAGSDEBUG= -std=c99 -march=i386 -mtune=i386 -Werror -Wall -O -ffreestanding -fleading-underscore -nostdlib -nostdinc -fno-builtin -fno-stack-protector -Isrc/include -ggdb
CC= i586-elf-gcc

LDFLAGS= -T kernel.ld -Map kernel.map -nostdinc
LDFLAGSDEBUG = -T kernel_debug.ld -Map kernel.map -nostdinc
LD= i586-elf-ld

OBJCOPY= i586-elf-objcopy

obj/%.o: src/%.asm
	@cecho {09}Assembling {#}{\t}==^> $<...
ifeq ($(DEBUG), 1)
	@$(NASM) $(ASFLAGSOBJDEBUG) $< -o $@
else
	@$(NASM) $(ASFLAGSOBJ) $< -o $@
endif
	@cecho .{0a}done{#}{\n}

obj/%.o: src/%.c
	@cecho {09}Compiling {#}{\t}==^> $<...
ifeq ($(TEST), 1)
ifeq ($(DEBUG), 1)
	@$(CC) $(CFLAGSDEBUG) "-D__VERSION_STRING=\"$(VERSION_STRING)\"" -D__VERSION_CHECKSUM=$(VERSION_CHECKSUM) -Isrc-test/include -D__TEST -c -o $@ $<
else
	@$(CC) $(CFLAGS) "-D__VERSION_STRING=\"$(VERSION_STRING)\"" -D__VERSION_CHECKSUM=$(VERSION_CHECKSUM) -Isrc-test/include -D__TEST -c -o $@ $<
endif
else
ifeq ($(DEBUG), 1)
	@$(CC) $(CFLAGSDEBUG) "-D__VERSION_STRING=\"$(VERSION_STRING)\"" -D__VERSION_CHECKSUM=$(VERSION_CHECKSUM) -c -o $@ $<
else
	@$(CC) $(CFLAGS) "-D__VERSION_STRING=\"$(VERSION_STRING)\"" -D__VERSION_CHECKSUM=$(VERSION_CHECKSUM) -c -o $@ $<
endif
endif
	@cecho .{0a}done{#}{\n}

obj-test/%.o: src-test/%.c
	@cecho {09}Compiling test {#}{\t}==^> $<...
ifeq ($(DEBUG), 1)
	@$(CC) $(CFLAGSDEBUG) -Isrc-test/include -c -o $@ $<
else
	@$(CC) $(CFLAGS) -Isrc-test/include -c -o $@ $<
endif
	@cecho .{0a}done{#}{\n}

ifeq ($(TEST), 1)
chaoskrn.sys: $(OBJECTS) $(OBJECTSTEST)
else
chaoskrn.sys: $(OBJECTS)
endif
ifeq ($(DEBUG), 1)
	@cecho {09}Linking Kernel{#}{\t}==^> chaoskrn.sys_debug...
	@$(LD) $(LDFLAGSDEBUG) $+ -o $@_debug
	@cecho .{0a}done{#}{\n}
	@cecho {09}Stripping chaoskrn.sys_debug{#}{\t}==^> chaoskrn.sys...
	@$(OBJCOPY) -O binary $@_debug $@
	@cecho .{0a}done{#}{\n}
else
	@cecho {09}Linking Kernel{#}{\t}==^> chaoskrn.sys...
	@$(LD) $(LDFLAGS) $+ -o $@
	@cecho .{0a}done{#}{\n}
endif

#    $<		Erste Abh�ngigkeit
#    $+		Liste aller Abh�ngigkeiten	
#    $@		Name des Targets
