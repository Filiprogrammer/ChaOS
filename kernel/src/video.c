#include "math.h"
#include "os.h"
#include "stdarg.h"
#include "string.h"
#include "vga.h"

// Video modes
// 0    Text        80x50x4
// 1    Text        80x25x4
// 2    Graphics    320x200x8

// 32 bit color format
// aaaaaaaarrrrrrrrggggggggbbbbbbbb

uint8_t video_mode = 0;
uint16_t csr_x = 0;
uint16_t csr_y = 0;
uint8_t txtcolor = 0x0F;
uint32_t color = 0xFFFFFFFF;
uint16_t width = 80;
uint16_t height = 50;
uint8_t saved_csr_x = 0;
uint8_t saved_csr_y = 0;

uint8_t* vidmem = (uint8_t*)0xB8000;

const uint8_t vga_font_8x16[] = {
    0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x24, 0x24, 0x7E, 0x24, 0x24, 0x7E, 0x24, 0x24, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x18, 0x7E, 0x60, 0x7E, 0x06, 0x06, 0x7E, 0x18, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x64, 0x64, 0x68, 0x08, 0x10, 0x16, 0x26, 0x26, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x3C, 0x6C, 0x60, 0x3E, 0x6C, 0x6C, 0x6C, 0x3E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00, 0x00,
    0x00, 0x00, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x18, 0x5A, 0x7E, 0x18, 0x7E, 0x5A, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7E, 0x7E, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x08, 0x38, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x06, 0x06, 0x0C, 0x0C, 0x18, 0x18, 0x30, 0x30, 0x60, 0x60, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x18, 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7C, 0x46, 0x06, 0x3C, 0x60, 0x60, 0x62, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7C, 0x46, 0x06, 0x3C, 0x06, 0x06, 0x46, 0x7C, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x0C, 0x1C, 0x3C, 0x6C, 0x4C, 0x7E, 0x0C, 0x0C, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x62, 0x60, 0x7C, 0x06, 0x06, 0x46, 0x7C, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x3E, 0x62, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x46, 0x06, 0x0C, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3E, 0x06, 0x46, 0x7C, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x08, 0x38, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x1E, 0x78, 0x1E, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x78, 0x1E, 0x78, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x06, 0x1E, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x3C, 0x42, 0x5A, 0x5A, 0x5E, 0x40, 0x7E, 0x3E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x18, 0x3C, 0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x60, 0x60, 0x60, 0x60, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x78, 0x6C, 0x66, 0x66, 0x66, 0x66, 0x6C, 0x78, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x60, 0x60, 0x7E, 0x60, 0x60, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x60, 0x60, 0x60, 0x7E, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x60, 0x6E, 0x66, 0x66, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x66, 0x6C, 0x78, 0x70, 0x78, 0x6C, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x62, 0x62, 0x76, 0x76, 0x7E, 0x6A, 0x6A, 0x6A, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x72, 0x72, 0x7A, 0x6A, 0x6A, 0x6E, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x66, 0x66, 0x7E, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x66, 0x74, 0x78, 0x0C, 0x06, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x60, 0x7E, 0x06, 0x06, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x62, 0x6A, 0x6A, 0x6A, 0x6A, 0x7E, 0x34, 0x34, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x0C, 0x18, 0x30, 0x60, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x60, 0x60, 0x30, 0x30, 0x18, 0x18, 0x0C, 0x0C, 0x06, 0x06, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x18, 0x3C, 0x66, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x06, 0x7E, 0x66, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x60, 0x60, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x60, 0x60, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x7E, 0x60, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x3E, 0x30, 0x7E, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x06, 0x3E, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x60, 0x60, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x78, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x1E, 0x06, 0x06, 0x06, 0x06, 0x06, 0x66, 0x7E, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x60, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x7E, 0x6A, 0x6A, 0x6A, 0x62, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x60, 0x60, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x06, 0x06, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x66, 0x70, 0x0E, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x7E, 0x30, 0x30, 0x30, 0x36, 0x3E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x62, 0x6A, 0x6A, 0x6A, 0x7E, 0x76, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x06, 0x3E, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x06, 0x0C, 0x30, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x32, 0x7E, 0x4C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x32, 0x5A, 0x4C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

inline uint8_t colorToRRRGGGBB(uint32_t rgb) {
    uint8_t r = rgb >> 16;
    uint8_t g = rgb >> 8;
    uint8_t b = rgb;
    return (r & 0xE0) | ((g & 0xE0) >> 3) | ((b & 0xC0) >> 6);
}

bool video_set_mode(uint8_t mode) {
    if (video_mode == mode)
        return true;

    uint8_t* ret = vga_set_mode(mode);
    if (ret == 0) return false;
    vidmem = ret;
    video_mode = mode;
    switch (mode) {
        case 0:
            width = 80;
            height = 50;
            csr_x = saved_csr_x;
            csr_y = saved_csr_y;
            break;
        case 1:
            width = 80;
            height = 25;
            csr_x = saved_csr_x;
            csr_y = saved_csr_y;
            break;
        case 2:
            width = 320;
            height = 200;
            saved_csr_x = csr_x;
            saved_csr_y = csr_y;
            break;
    }
    return true;
}

uint8_t video_get_mode() {
    return video_mode;
}

void set_cursor(uint16_t x, uint16_t y) {
    csr_x = x;
    csr_y = y;
    if (video_mode <= 1) {
        vga_update_cursor(width * y + x);
    }
}

void move_cursor_right() {
    if ((csr_x + 1) >= width) {
        if ((csr_y + 1) < height) {
            set_cursor(0, csr_y + 1);
        }
    } else {
        set_cursor(csr_x + 1, csr_y);
    }
}

void move_cursor_left() {
    if (csr_x) {
        set_cursor(csr_x - 1, csr_y);
    } else if (csr_y) {
        set_cursor(width - 1, csr_y - 1);
    }
}

void move_cursor_home() {
    set_cursor(0, csr_y);
}

void move_cursor_end() {
    set_cursor(width - 1, csr_y);
}

void clear_screen() {
    if (video_mode <= 1) {
        memsetw((uint16_t*)vidmem, 0x20 | (txtcolor << 8), width * height);
    } else if (video_mode == 2) {
        memset(vidmem, 0, width * height);
    }
    set_cursor(0, 0);
}

static uint8_t transferFromAsciiToCodepage437(uint8_t ascii) {
    uint8_t c;

    if (ascii == 0xE4)
        c = 0x84;  // ä
    else if (ascii == 0xF6)
        c = 0x94;  // ö
    else if (ascii == 0xFC)
        c = 0x81;  // ü
    else if (ascii == 0xDF)
        c = 0xE1;  // ß
    else if (ascii == 0xA7)
        c = 0x15;  // §
    else if (ascii == 0xB0)
        c = 0xF8;  // °
    else if (ascii == 0xC4)
        c = 0x8E;  // Ä
    else if (ascii == 0xD6)
        c = 0x99;  // Ö
    else if (ascii == 0xDC)
        c = 0x9A;  // Ü
    else if (ascii == 0xB2)
        c = 0xFD;  // ²
    else if (ascii == 0xB3)
        c = 0x00;  // ³ <-- not available
    else if (ascii == 0x80)
        c = 0xEE;  // € <-- Greek epsilon used
    else if (ascii == 0xB5)
        c = 0xE6;  // µ
    else
        c = ascii;

    return c;
}

void putch(char c) {
    if (video_mode <= 1) {
        uint8_t uc = transferFromAsciiToCodepage437((uint8_t)c);  // no negative values

        uint16_t* pos;

        if (uc == '\b') {  // backspace: move the cursor one space backwards and delete
            if (csr_x) {
                --csr_x;
                pos = (uint16_t*)vidmem + (csr_y * width + csr_x);
                *pos = ' ' | ((txtcolor & 0xFF) << 8);
            } else if (!csr_x && csr_y > 0) {
                csr_x = width - 1;
                --csr_y;
                pos = (uint16_t*)vidmem + (csr_y * width + csr_x);
                *pos = ' ' | ((txtcolor & 0xFF) << 8);
            }
        } else if (uc == '\t')  // tab: increment csr_x (divisible by 8)
            csr_x = (csr_x + 8) & ~(8 - 1);
        else if (uc == '\r')  // cr: cursor back to the margin
            csr_x = 0;
        else if (uc == '\n') {  // newline: like 'cr': cursor to the margin and increment csr_y
            csr_x = 0;
            ++csr_y;
        } else if (uc != 0) {
            pos = (uint16_t*)vidmem + (csr_y * width + csr_x);
            *pos = uc | ((txtcolor & 0xFF) << 8);  // character AND attributes: color
            ++csr_x;
        }

        if (csr_x >= width) {  // cursor reaches edge of the screen's width, a new line is inserted
            csr_x = 0;
            ++csr_y;
        }

        // scroll if needed, and finally move the cursor
        scroll();
        vga_update_cursor(csr_y * width + csr_x);
    } else if (video_mode == 2) {
        if (c >= 33 && c <= 127) {
            uint8_t colorindex = colorToRRRGGGBB(color);
            for (uint8_t i = 0; i < 16; ++i) {
                for (uint8_t j = 0; j < 8; ++j) {
                    if (csr_x + j < 0 || width <= csr_x + j || csr_y + i < 0 || height <= csr_y + i) {
                        continue;
                    }
                    if (vga_font_8x16[(c - 33) * 16 + i] & (0x80 >> j)) {
                        vidmem[width * (csr_y + i) + csr_x + j] = colorindex;
                    }
                }
            }
        }
        csr_x += 8;
        if (csr_x >= width)  // cursor reaches edge of the screen's width, a new line is inserted
        {
            csr_x = 0;
            csr_y += 16;
        }
    }
}

void settextcolor(uint8_t forecolor, uint8_t backcolor) {
    // Top 4 bytes: background, bottom 4 bytes: foreground color
    txtcolor = (backcolor << 4) | (forecolor & 0x0F);
}

void setgraphcolor(uint32_t rgb) {
    color = rgb;
}

void scroll() {
    if (video_mode <= 1) {
        if (csr_y >= height) {
            uint32_t temp = csr_y - height + 1;
            memcpy(vidmem, vidmem + temp * width * 2, (height - temp) * width * 2);
            memsetw((uint16_t*)vidmem + (height - temp) * width, ' ' | ((txtcolor & 0xFF) << 8), width);
            csr_y = height - 1;
        }
    }
}

void puts(const char* text) {
    for (; *text; putch(*text), ++text)
        ;
}

void printf(const char* args, ...) {
    va_list ap;
    va_start(ap, args);
    int32_t index = 0, d;
    uint32_t u;
    char c, *s;
    char buffer[32];

    while (args[index]) {
        switch (args[index]) {
            case '%':
                ++index;
                switch (args[index]) {
                    case 'u':
                        u = va_arg(ap, uint32_t);
                        uitoa(u, buffer);
                        puts(buffer);
                        break;
                    case 'd':
                    case 'i':
                        d = va_arg(ap, int32_t);
                        itoa(d, buffer);
                        puts(buffer);
                        break;
                    case 'X':
                        d = va_arg(ap, int32_t);
                        i2hex(d, buffer, 8);
                        puts(buffer);
                        break;
                    case 'x':
                        d = va_arg(ap, int32_t);
                        i2hex(d, buffer, 4);
                        puts(buffer);
                        break;
                    case 's':
                        s = va_arg(ap, char*);
                        puts(s);
                        break;
                    case 'c':
                        c = (char)va_arg(ap, int32_t);
                        putch(c);
                        break;
                    default:
                        putch('%');
                        putch('%');
                        break;
                }
                break;

            default:
                putch(args[index]);
                break;
        }
        ++index;
    }
}

void draw_rectangle(int16_t x, int16_t y, int16_t w, int16_t h) {
    if (video_mode == 2) {
        if (w <= 0 || h <= 0) return;
        int16_t X;
        int16_t Y;
        int16_t Xmax = MIN(x + w, width);
        int16_t Ymax = MIN(y + h, height);
        uint8_t colorindex = colorToRRRGGGBB(color);
        uint32_t a = (color >> 24) & 0xFF;
        if (a == 0xFF) {
            for (Y = MAX(y, 0); Y < Ymax; ++Y) {
                for (X = MAX(x, 0); X < Xmax; ++X) {
                    vidmem[width * Y + X] = colorindex;
                }
            }
        } else {
            uint32_t r = (color >> 16) & 0xFF;
            uint32_t g = (color >> 8) & 0xFF;
            uint32_t b = color & 0xFF;
            for (Y = MAX(y, 0); Y < Ymax; ++Y) {
                for (X = MAX(x, 0); X < Xmax; ++X) {
                    uint8_t prev_col = vidmem[width * Y + X];
                    uint32_t r_prev = prev_col & 0xE0;
                    uint32_t g_prev = (prev_col << 3) & 0xE0;
                    uint32_t b_prev = prev_col << 6;
                    uint32_t r_new = (a * r + (255 - a) * r_prev) / 255;
                    uint32_t g_new = (a * g + (255 - a) * g_prev) / 255;
                    uint32_t b_new = (a * b + (255 - a) * b_prev) / 255;
                    vidmem[width * Y + X] = (r_new & 0xE0) | ((g_new & 0xE0) >> 3) | ((b_new & 0xC0) >> 6);
                }
            }
        }
    }
}

void put_pixel(int16_t x, int16_t y) {
    if (video_mode == 2) {
        if (x < 0 || width <= x || y < 0 || height <= y) {
            return;
        }
        vidmem[width * y + x] = colorToRRRGGGBB(color);
    }
}

void draw_picture_part(const uint8_t* picture, int16_t x, int16_t y, int16_t xoffset, int16_t yoffset, uint16_t w, uint16_t h) {
    if (video_mode == 2) {
        uint16_t W = (picture[0] << 8) + picture[1];
        uint16_t H = (picture[2] << 8) + picture[3];
        int16_t maxH = MIN(MIN(y + H, y + yoffset + h), height);
        int16_t maxW = MIN(MIN(x + W, x + xoffset + w), width);
        xoffset = MAX(x + MAX(xoffset, 0), 0);
        yoffset = MAX(y + MAX(yoffset, 0), 0);
        for (int16_t j = yoffset; j < maxH; ++j) {
            for (int16_t i = xoffset; i < maxW; ++i) {
                vidmem[width * j + i] = picture[4 + (j - y) * W + (i - x)];
            }
        }
    }
}

void draw_picture(const uint8_t* picture, int16_t x, int16_t y) {
    draw_picture_part(picture, x, y, 0, 0, width, height);
}

void draw_picture_part32(const uint32_t* picture, int16_t x, int16_t y, int16_t xoffset, int16_t yoffset, uint16_t w, uint16_t h) {
    if (video_mode == 2) {
        uint16_t W = picture[0];
        uint16_t H = picture[1];
        int16_t maxH = MIN(MIN(y + H, y + yoffset + h), height);
        int16_t maxW = MIN(MIN(x + W, x + xoffset + w), width);
        xoffset = MAX(x + MAX(xoffset, 0), 0);
        yoffset = MAX(y + MAX(yoffset, 0), 0);
        for (int16_t j = yoffset; j < maxH; ++j) {
            for (int16_t i = xoffset; i < maxW; ++i) {
                if (picture[2 + (j - y) * W + (i - x)] & 0xFF000000) vidmem[width * j + i] = colorToRRRGGGBB(picture[2 + (j - y) * W + (i - x)]);
            }
        }
    }
}

void draw_picture32(const uint32_t* picture, int16_t x, int16_t y) {
    draw_picture_part32(picture, x, y, 0, 0, width, height);
}

void draw_text_part(int16_t x, int16_t y, const char* text, int16_t xoffset, int16_t yoffset, int16_t w, int16_t h) {
    if (video_mode == 2) {
        xoffset = CLAMP(xoffset, 0, width - 1);
        yoffset = CLAMP(yoffset, 0, height - 1);
        w = MIN(xoffset + w, width);
        h = MIN(yoffset + h, height);
        uint8_t colorindex = colorToRRRGGGBB(color);
        while (*text != 0) {
            if (*text >= 33 && *text <= 127) {
                for (uint8_t i = 0; i < 16; ++i) {
                    for (uint8_t j = 0; j < 8; ++j) {
                        if (((x + j) >= xoffset) && ((x + j) < w) && ((y + i) >= yoffset) && ((y + i) < h)) {
                            if (vga_font_8x16[(*text - 33) * 16 + i] & (0x80 >> j)) {
                                vidmem[width * (y + i) + x + j] = colorindex;
                            }
                        }
                    }
                }
            }
            x += 8;
            ++text;
        }
    }
}
