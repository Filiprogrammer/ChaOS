#include "os.h"

#define VGAMISCPORT 0x3c2
#define VGACRTCINDEXPORT 0x3d4
#define VGACRTCDATAPORT 0x3d5
#define VGASEQUENCERINDEXPORT 0x3c4
#define VGASEQUENCERDATAPORT 0x3c5
#define VGAGRAPHICSCONTROLLERINDEXPORT 0x3ce
#define VGAGRAPHICSCONTROLLERDATAPORT 0x3cf
#define VGAATTRIBUTECONTROLLERINDEXPORT 0x3c0
#define VGAATTRIBUTECONTROLLERREADPORT 0x3c1
#define VGAATTRIBUTECONTROLLERWRITEPORT 0x3c0
#define VGAATTRIBUTECONTROLLERRESETPORT 0x3da

const uint8_t vga_text_palette[] = {
    0x00, 0x00, 0x00,
    0x00, 0x00, 0x2A,
    0x00, 0x2A, 0x00,
    0x00, 0x2A, 0x2A,
    0x2A, 0x00, 0x00,
    0x2A, 0x00, 0x2A,
    0x2A, 0x2A, 0x00,
    0x2A, 0x2A, 0x2A,
    0x00, 0x00, 0x15,
    0x39, 0x00, 0x3F,
    0x3A, 0x2A, 0x15,
    0x3B, 0x2A, 0x3F,
    0x2A, 0x00, 0x15,
    0x2A, 0x00, 0x3F,
    0x2A, 0x2A, 0x15,
    0x2A, 0x2A, 0x3F,
    0x00, 0x15, 0x00,
    0x00, 0x15, 0x2A,
    0x00, 0x3F, 0x00,
    0x00, 0x3F, 0x2A,
    0x2A, 0x15, 0x00,
    0x2A, 0x15, 0x2A,
    0x2A, 0x3F, 0x00,
    0x2A, 0x3F, 0x2A,
    0x00, 0x15, 0x15,
    0x00, 0x15, 0x3F,
    0x00, 0x3F, 0x15,
    0x00, 0x3F, 0x3F,
    0x2A, 0x15, 0x15,
    0x2A, 0x15, 0x3F,
    0x2A, 0x3F, 0x15,
    0x2A, 0x3F, 0x3F,
    0x15, 0x00, 0x00,
    0x15, 0x00, 0x2A,
    0x15, 0x2A, 0x00,
    0x15, 0x2A, 0x2A,
    0x3F, 0x00, 0x00,
    0x3F, 0x00, 0x2A,
    0x3F, 0x2A, 0x00,
    0x3F, 0x2A, 0x2A,
    0x15, 0x00, 0x15,
    0x15, 0x00, 0x3F,
    0x15, 0x2A, 0x15,
    0x15, 0x2A, 0x3F,
    0x3F, 0x00, 0x15,
    0x3F, 0x00, 0x3F,
    0x3F, 0x2A, 0x15,
    0x3F, 0x2A, 0x3F,
    0x15, 0x15, 0x00,
    0x15, 0x15, 0x2A,
    0x15, 0x3F, 0x00,
    0x15, 0x3F, 0x2A,
    0x3F, 0x15, 0x00,
    0x3F, 0x15, 0x2A,
    0x3F, 0x3F, 0x00,
    0x3F, 0x3F, 0x2A,
    0x15, 0x15, 0x15,
    0x15, 0x15, 0x3F,
    0x15, 0x3F, 0x15,
    0x15, 0x3F, 0x3F,
    0x3F, 0x15, 0x15,
    0x3F, 0x15, 0x3F,
    0x3F, 0x3F, 0x15,
    0x3F, 0x3F, 0x3F};

uint8_t vga_text_mode_backup[64000];

uint8_t g_320x200x256[] = {
    /* MISC */
    0x63,
    /* SEQ */
    0x03, 0x01, 0x0F, 0x00, 0x0E,
    /* CRTC */
    0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0xBF, 0x1F,
    0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x9C, 0x0E, 0x8F, 0x28, 0x40, 0x96, 0xB9, 0xA3,
    0xFF,
    /* GC */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0F,
    0xFF,
    /* AC */
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
    0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
    0x41, 0x00, 0x0F, 0x00, 0x00};

uint8_t g_80x50_text[] = {
    /* MISC */
    0x67,
    /* SEQ */
    0x03, 0x00, 0x03, 0x00, 0x02,
    /* CRTC */
    0x5F, 0x4F, 0x50, 0x82, 0x55, 0x81, 0xBF, 0x1F,
    0x00, 0x47, 0x06, 0x07, 0x00, 0x00, 0x01, 0x40,
    0x9C, 0x8E, 0x8F, 0x28, 0x1F, 0x96, 0xB9, 0xA3,
    0xFF,
    /* GC */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0E, 0x00,
    0xFF,
    /* AC */
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
    0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
    0x0C, 0x00, 0x0F, 0x08, 0x00};

void vga_write_registers(uint8_t* registers) {
    // misc
    outportb(VGAMISCPORT, *(registers++));

    // sequencer
    uint8_t i;
    for (i = 0; i < 5; ++i) {
        outportb(VGASEQUENCERINDEXPORT, i);
        outportb(VGASEQUENCERDATAPORT, *(registers++));
    }

    // cathode ray tube controller
    outportb(VGACRTCINDEXPORT, 0x03);
    outportb(VGACRTCDATAPORT, inportb(VGACRTCDATAPORT) | 0x80);
    outportb(VGACRTCINDEXPORT, 0x11);
    outportb(VGACRTCDATAPORT, inportb(VGACRTCDATAPORT) & ~0x80);

    registers[0x03] = registers[0x03] | 0x80;
    registers[0x11] = registers[0x11] & ~0x80;

    for (i = 0; i < 25; ++i) {
        outportb(VGACRTCINDEXPORT, i);
        outportb(VGACRTCDATAPORT, *(registers++));
    }

    // graphics controller
    for (i = 0; i < 9; ++i) {
        outportb(VGAGRAPHICSCONTROLLERINDEXPORT, i);
        outportb(VGAGRAPHICSCONTROLLERDATAPORT, *(registers++));
    }

    // attribute controller
    for (i = 0; i < 21; ++i) {
        inportb(VGAATTRIBUTECONTROLLERRESETPORT);
        outportb(VGAATTRIBUTECONTROLLERINDEXPORT, i);
        outportb(VGAATTRIBUTECONTROLLERWRITEPORT, *(registers++));
    }

    inportb(VGAATTRIBUTECONTROLLERRESETPORT);
    outportb(VGAATTRIBUTECONTROLLERINDEXPORT, 0x20);
}

uint8_t* vga_getFrameBufferSegment() {
    outportb(VGAGRAPHICSCONTROLLERINDEXPORT, 0x06);
    uint8_t segmentNumber = inportb(VGAGRAPHICSCONTROLLERDATAPORT) & (3 << 2);
    switch (segmentNumber) {
        default:
        case 0 << 2:
            return (uint8_t*)0x00000;
        case 1 << 2:
            return (uint8_t*)0xA0000;
        case 2 << 2:
            return (uint8_t*)0xB0000;
        case 3 << 2:
            return (uint8_t*)0xB8000;
    }
}

void vga_set_palette_graph() {
    outportb(0x03c8, 0);
    for (uint16_t i = 0; i < 256; ++i) {
        /* 8 bit palette will be:
        rrrgggbb
        */
        uint8_t red = ((i >> 5) & 7) * 63 / 7;
        uint8_t green = ((i >> 2) & 7) * 63 / 7;
        uint8_t blue = (i & 3) * 63 / 3;

        outportb(0x03c9, red);
        outportb(0x03c9, green);
        outportb(0x03c9, blue);
    }
}

void vga_set_palette_text() {
    outportb(0x03c8, 0);
    uint16_t i;
    for (i = 0; i < 64; ++i) {
        outportb(0x03c9, vga_text_palette[i * 3]);
        outportb(0x03c9, vga_text_palette[i * 3 + 1]);
        outportb(0x03c9, vga_text_palette[i * 3 + 2]);
    }
    for (i = 0; i < 192 * 3; ++i)
        outportb(0x03c9, 0);
}

uint8_t* vga_set_mode(uint8_t mode) {
    if (mode == 2) {
        vga_write_registers(g_320x200x256);
        vga_set_palette_graph();
        uint8_t* pixelAddress = vga_getFrameBufferSegment();
        for (uint16_t i = 0; i < 64000; ++i)
            vga_text_mode_backup[i] = pixelAddress[i];

        return pixelAddress;
    } else if (mode == 1) {
    } else if (mode == 0) {
        uint8_t* pixelAddress = vga_getFrameBufferSegment();
        for (uint16_t i = 0; i < 64000; ++i)
            pixelAddress[i] = vga_text_mode_backup[i];

        vga_write_registers(g_80x50_text);
        vga_set_palette_text();
        return vga_getFrameBufferSegment();
    }
    return 0;
}

void vga_update_cursor(uint16_t pos) {
    // cursor HIGH port to vga INDEX register
    outportb(0x3D4, 0x0E);
    outportb(0x3D5, (uint8_t)((pos >> 8) & 0xFF));
    // cursor LOW port to vga INDEX register
    outportb(0x3D4, 0x0F);
    outportb(0x3D5, (uint8_t)(pos & 0xFF));
};
